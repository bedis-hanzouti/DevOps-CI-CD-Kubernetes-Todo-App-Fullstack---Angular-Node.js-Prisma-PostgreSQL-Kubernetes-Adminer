name: CI/CD Todo-App (Minikube Docker Driver)

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  ci-cd:
    name: Build, Push Docker Hub & Deploy on Minikube
    runs-on: ubuntu-latest

    steps:
      # ==========================
      # 1Ô∏è‚É£ Checkout code
      # ==========================
      - name: Checkout repository
        uses: actions/checkout@v3

      # ==========================
      # 2Ô∏è‚É£ Set up Docker Buildx
      # ==========================
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ==========================
      # 3Ô∏è‚É£ Login Docker Hub
      # ==========================
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # ==========================
      # 4Ô∏è‚É£ Build & Push Backend
      # ==========================
      - name: Build and Push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/backend-api:${{ github.sha }}
            ${{ secrets.DOCKER_USERNAME }}/backend-api:latest

      # ==========================
      # 5Ô∏è‚É£ Build & Push Frontend
      # ==========================
      - name: Build and Push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/frontend:${{ github.sha }}
            ${{ secrets.DOCKER_USERNAME }}/frontend:latest

      # ==========================
      # 6Ô∏è‚É£ Installer kubectl et Minikube
      # ==========================
      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Install Minikube
        run: |
          curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
          sudo install minikube-linux-amd64 /usr/local/bin/minikube

      # ==========================
      # 7Ô∏è‚É£ Start Minikube & Ingress
      # ==========================
      - name: Start Minikube
        run: |
          minikube start --driver=docker --memory=4g --cpus=2
          minikube addons enable ingress
          minikube status

      # ==========================
      # 8Ô∏è‚É£ Update Kubernetes manifests avec SHA
      # ==========================
      - name: Update Kubernetes Images
        run: |
          sed -i "s|backend-api:latest|${{ secrets.DOCKER_USERNAME }}/backend-api:${{ github.sha }}|g" k8s/backend/backend-deployment.yaml
          sed -i "s|frontend:latest|${{ secrets.DOCKER_USERNAME }}/frontend:${{ github.sha }}|g" k8s/frontend/frontend-deployment.yaml

      # ==========================
      # 9Ô∏è‚É£ D√©ployer Kubernetes avec secrets/configmaps
      # ==========================
      - name: Deploy Kubernetes Resources
        run: |
          kubectl apply -f k8s/namespace.yaml

          # Secrets PostgreSQL
          kubectl create secret generic postgres-secret \
            --from-literal=POSTGRES_USER=${{ secrets.POSTGRES_USER }} \
            --from-literal=POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }} \
            --from-literal=POSTGRES_DB=${{ secrets.POSTGRES_DB }} \
            --from-literal=DATABASE_URL=postgresql://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@${{ secrets.DATABASE_HOST }}:${{ secrets.DATABASE_PORT }}/${{ secrets.POSTGRES_DB }} \
            -n todo-app --dry-run=client -o yaml | kubectl apply -f -

          # ConfigMap backend
          kubectl create configmap backend-config \
            --from-literal=PORT=${{ secrets.BACKEND_PORT }} \
            --from-literal=DATABASE_HOST=${{ secrets.DATABASE_HOST }} \
            --from-literal=DATABASE_PORT=${{ secrets.DATABASE_PORT }} \
            --from-literal=POSTGRES_USER=${{ secrets.POSTGRES_USER }} \
            --from-literal=POSTGRES_DB=${{ secrets.POSTGRES_DB }} \
            -n todo-app --dry-run=client -o yaml | kubectl apply -f -

          # PostgreSQL
          kubectl apply -f k8s/postgres/postgres-pvc.yaml
          kubectl apply -f k8s/postgres/postgres-deployment.yaml
          kubectl apply -f k8s/postgres/postgres-service.yaml

          # Backend / Frontend / Adminer
          kubectl apply -f k8s/backend/backend-deployment.yaml
          kubectl apply -f k8s/backend/backend-service.yaml
          kubectl apply -f k8s/frontend/frontend-deployment.yaml
          kubectl apply -f k8s/frontend/frontend-service.yaml
          kubectl apply -f k8s/adminer/adminer-deployment.yaml
          kubectl apply -f k8s/adminer/adminer-service.yaml

          # Ingress
          kubectl apply -f k8s/ingress.yaml

      # ==========================
      # üîü Wait for pods ready
      # ==========================
      - name: Wait for pods ready
        run: |
          kubectl wait --for=condition=ready pod -l app=postgres -n todo-app --timeout=120s
          kubectl wait --for=condition=ready pod -l app=backend -n todo-app --timeout=120s
          kubectl wait --for=condition=ready pod -l app=frontend -n todo-app --timeout=120s
          kubectl wait --for=condition=ready pod -l app=adminer -n todo-app --timeout=120s

      # ==========================
      # 1Ô∏è‚É£1Ô∏è‚É£ V√©rification rapide
      # ==========================
      - name: Check Pods, Services & Ingress
        run: |
          kubectl get pods -n todo-app
          kubectl get svc -n todo-app
          kubectl get ingress -n todo-app

      # ==========================
      # 1Ô∏è‚É£2Ô∏è‚É£ Test Backend API
      # ==========================
      - name: Test Backend
        run: |
          kubectl run testpod --rm -i --image=busybox --namespace=todo-app -- sh -c "wget -qO- http://backend:3000/health || echo 'Backend not ready'"


































































































































































































































# name: CI/CD Todo-App (Full Pipeline)

# on:
#   push:
#     branches: [ main, dev ]
#   pull_request:
#     branches: [ main, dev ]

# jobs:
#   ci-cd:
#     runs-on: ubuntu-latest

#     steps:

#     # ==========================
#     # 1Ô∏è‚É£ Checkout
#     # ==========================
#     - name: Checkout code
#       uses: actions/checkout@v4

#     # ==========================
#     # 2Ô∏è‚É£ Extract branch name
#     # ==========================
#     - name: Get branch name
#       run: echo "BRANCH=${GITHUB_REF##*/}" >> $GITHUB_ENV

#     # ==========================
#     # 3Ô∏è‚É£ Backend Tests
#     # ==========================
#     - name: Setup Node.js (Backend)
#       uses: actions/setup-node@v4
#       with:
#         node-version: 18

#     - name: Install Backend Dependencies
#       run: |
#         cd backend
#         npm install

#     # - name: Run Backend Tests
#     #   run: |
#     #     cd backend
#     #     npm test

#     # ==========================
#     # 4Ô∏è‚É£ Frontend Tests
#     # ==========================
#     - name: Install Frontend Dependencies
#       run: |
#         cd frontend
#         npm install

#     # - name: Run Frontend Tests
#     #   run: |
#     #     cd frontend
#     #     npm test -- --watchAll=false

#     # ==========================
#     # 5Ô∏è‚É£ Docker Setup
#     # ==========================
#     - name: Set up Docker Buildx
#       uses: docker/setup-buildx-action@v3

#     - name: Login to Docker Hub
#       uses: docker/login-action@v3
#       with:
#         username: ${{ secrets.DOCKER_USERNAME }}
#         password: ${{ secrets.DOCKER_PASSWORD }}

#     # ==========================
#     # 6Ô∏è‚É£ Build & Push Backend
#     # ==========================
#     - name: Build & Push Backend
#       uses: docker/build-push-action@v5
#       with:
#         context: ./backend
#         push: true
#         tags: |
#           ${{ secrets.DOCKER_USERNAME }}/todo-backend:${{ env.BRANCH }}
#           ${{ secrets.DOCKER_USERNAME }}/todo-backend:${{ github.sha }}

#     # ==========================
#     # 7Ô∏è‚É£ Build & Push Frontend
#     # ==========================
#     - name: Build & Push Frontend
#       uses: docker/build-push-action@v5
#       with:
#         context: ./frontend
#         push: true
#         tags: |
#           ${{ secrets.DOCKER_USERNAME }}/todo-frontend:${{ env.BRANCH }}
#           ${{ secrets.DOCKER_USERNAME }}/todo-frontend:${{ github.sha }}

#     # ==========================
#     # 8Ô∏è‚É£ Scan s√©curit√© Docker (Trivy)
#     # ==========================
#     - name: Scan Backend Image
#       uses: aquasecurity/trivy-action@master
#       with:
#         image-ref: ${{ secrets.DOCKER_USERNAME }}/todo-backend:${{ env.BRANCH }}
#         format: table
#         exit-code: 1
#         ignore-unfixed: true
#         severity: CRITICAL,HIGH

#     # ==========================
#     # 9Ô∏è‚É£ Install kubectl & Minikube
#     # ==========================
#     - name: Install kubectl
#       uses: azure/setup-kubectl@v4

#     - name: Install Minikube
#       run: |
#         curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
#         sudo install minikube-linux-amd64 /usr/local/bin/minikube

#     - name: Start Minikube
#       run: |
#         minikube start --driver=docker --memory=4g --cpus=2
#         minikube addons enable ingress

#     # ==========================
#     # üîü Deploy Kubernetes
#     # ==========================
#     - name: Deploy Manifests
#       run: kubectl apply -f k8s/

#     - name: Update Images
#       run: |
#         kubectl set image deployment/backend backend=${{ secrets.DOCKER_USERNAME }}/todo-backend:${{ env.BRANCH }} -n todo-app
#         kubectl set image deployment/frontend frontend=${{ secrets.DOCKER_USERNAME }}/todo-frontend:${{ env.BRANCH }} -n todo-app

#     # ==========================
#     # 1Ô∏è‚É£1Ô∏è‚É£ Wait for rollout
#     # ==========================
#     - name: Wait for Deployments
#       run: |
#         kubectl rollout status deployment/backend -n todo-app
#         kubectl rollout status deployment/frontend -n todo-app

#     # ==========================
#     # 1Ô∏è‚É£2Ô∏è‚É£ Verification Pods
#     # ==========================
#     - name: Check Pods Status
#       run: kubectl get pods -n todo-app

#     # ==========================
#     # 1Ô∏è‚É£3Ô∏è‚É£ Backend Health Check
#     # ==========================
#     - name: Test Backend API
#       run: |
#         kubectl run testpod --rm -i --tty \
#           --image=busybox \
#           --namespace=todo-app \
#           -- sh -c "wget -qO- http://backend:3000/health"
